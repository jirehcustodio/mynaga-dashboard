# Enhanced Two-Way Sync: Dashboard ↔ Google Sheets
## NEW: Cluster, Office & MyNaga App Status Management

**Last Updated:** October 22, 2025  
**Status:** ✅ Production Ready

---

## 🎯 What's New

You can now edit these fields in your dashboard and they will **automatically sync to Google Sheets**:

### 1. **Cluster** (Column D)
- Text field for clustering/grouping cases
- Examples: "Cluster A", "Downtown", "Barangay Group 1"
- Syncs immediately to Column D in Google Sheets

### 2. **Office** (Column I)
- Dropdown selection of government offices
- 23 offices available (PSO, GSO, CEO, SWMO, CENRO, etc.)
- Syncs immediately to Column I in Google Sheets

### 3. **MyNaga App Status** (Column M)
- Dropdown with 11 status options:
  - In Progress
  - Pending Confirmation
  - Pending Review
  - Under Review
  - Resolved
  - Rejected - Out of Scope
  - Rejected - Unclear Report
  - Rejected - Test
  - Rejected
  - Withdrawn
  - No Status Yet
- Syncs immediately to Column M in Google Sheets

### 4. **Updates Sent to User** (Column N) - READ-ONLY
- Auto-generated message based on office assignment
- Populated by your AppScript when Office (Column I) is changed
- Displays in dashboard (read-only)
- Based on your existing AppScript logic

---

## 📊 Column Mapping

| Google Sheets Column | Field Name | Editable | Description |
|---------------------|------------|----------|-------------|
| **Column D** | Cluster | ✅ Yes | Cluster/group assignment |
| **Column I** | Office | ✅ Yes | Assigned government office |
| **Column M** | MyNaga App Status | ✅ Yes | Report status in MyNaga App |
| **Column N** | Updates Sent to User | ❌ Read-only | Auto-response message (generated by AppScript) |

---

## 🏢 Available Offices

Your dashboard includes all offices from your AppScript:

### **Queue-Based Offices** (with queue numbers):
- **PSO** - Public Safety Office
- **GSO** - General Services Office
- **CEO** - CMO Special Unit for Engineering
- **SWMO** - Solid Waste Management Office
- **CENRO** - City Environment and Natural Resources Office
- **CVO** - City Veterinary Office
- **CSWD** - City Social Welfare and Development
- **NCGH** - Naga City General Hospital
- **CHO** - City Health Office
- **CPRFMO** - City Parks & Recreational Facilities Management
- **CTO** - City Treasurer's Office
- **MEPO** - Market Enterprise and Promotions Office
- **HSDO** - Housing and Development Office
- **BCS** - Bicol Central Station
- **CPDO** - City Planning and Development Office

### **Fixed Response Offices**:
- **SP-SEC** - Sangguniang Panlunsod Secretariat
- **CEPPIO** - City Events, Protocol & Public Information
- **MNWD** - Metro Naga Water District
- **CASURECO**
- **DOLE**
- **PSA** - Philippine Statistics Authority
- **DTI**

---

## ⚙️ How It Works

### Workflow Diagram

```
┌─────────────────────────────────────────────────────────┐
│                   Dashboard Edit                         │
│  (Edit case → Change Office to "PSO")                   │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
          ┌──────────────────────┐
          │  Save to Database    │
          │  (PostgreSQL/SQLite) │
          └──────────┬───────────┘
                     │
                     ▼
          ┌──────────────────────┐
          │  Write to Google     │
          │  Sheets (Column I)   │
          └──────────┬───────────┘
                     │
                     ▼
          ┌──────────────────────┐
          │  AppScript Trigger   │
          │  onEdit(Column I)    │
          └──────────┬───────────┘
                     │
                     ▼
          ┌──────────────────────┐
          │  Generate Auto-      │
          │  Response Message    │
          │  (Write to Column N) │
          └──────────┬───────────┘
                     │
                     ▼
          ┌──────────────────────┐
          │  Next Auto-Sync      │
          │  (10 seconds)        │
          │  Reads Column N      │
          └──────────┬───────────┘
                     │
                     ▼
          ┌──────────────────────┐
          │  Dashboard shows     │
          │  auto-response       │
          └──────────────────────┘
```

---

## 🚀 Usage Guide

### Step 1: Open a Case

1. Navigate to **Cases** page: http://localhost:3000/cases
2. Click on any case row
3. Case detail modal opens in **View Mode**

### Step 2: Enter Edit Mode

1. Click **"Edit Case"** button at the bottom
2. Modal switches to **Edit Mode** with form fields

### Step 3: Assign Cluster (Column D)

```
Field: Cluster
Type: Text Input
Example: "Cluster A", "Downtown Group", "Barangay 1"
```

- Enter any cluster name you want
- This helps organize cases geographically or by group
- Syncs to Column D in Google Sheets

### Step 4: Assign Office (Column I)

```
Field: Office
Type: Dropdown
Options: PSO, GSO, CEO, SWMO, CENRO, CVO, CSWD, etc.
```

- Select the responsible office from dropdown
- **Triggers AppScript** when synced to Google Sheets
- AppScript generates auto-response message

### Step 5: Update MyNaga App Status (Column M)

```
Field: MyNaga App Status
Type: Dropdown
Options:
  - In Progress
  - Pending Confirmation
  - Pending Review
  - Under Review
  - Resolved
  - Rejected - Out of Scope
  - Rejected - Unclear Report
  - Rejected - Test
  - Rejected
  - Withdrawn
  - No Status Yet
```

- Select current status of the case
- Reflects the actual status in MyNaga App system
- Syncs to Column M in Google Sheets

### Step 6: Save Changes

1. Click **"Update Case"** button
2. Changes save to database immediately
3. Two-way sync writes to Google Sheets (Columns D, I, M)
4. AppScript triggers (if Office changed)
5. Auto-response generated in Column N

### Step 7: View Auto-Response

1. Wait 10 seconds for auto-sync
2. Click the case again to view
3. **View Mode** shows auto-response message at the bottom
4. Blue box displays "Updates Sent to User" message

---

## 📝 Example Scenario

### Scenario: Assigning a Road Pothole Report

**Initial State:**
```
Control No: CN-2024-1234
Category: Road Damage
Description: Large pothole on Main Street
Cluster: (empty)
Office: (empty)
MyNaga App Status: No Status Yet
```

**Step 1: Edit and Assign**
```
Cluster: Downtown Cluster
Office: GSO (General Services Office)
MyNaga App Status: In Progress
```

**Step 2: Save**
- Dashboard saves to database ✅
- Writes to Google Sheets:
  - Column D ← "Downtown Cluster"
  - Column I ← "GSO"
  - Column M ← "In Progress"

**Step 3: AppScript Triggers**
- AppScript detects Office change (Column I)
- Reads "Daily Reporting" sheet for queue number
- Generates auto-response:

```
The City Mayor's Office (CMO) has processed your submission.
Your report/request is now in queue to be handled by the General Services Office (GSO) through MyNaga App.
We appreciate your patience as we are experiencing a surge in community reports.
Your report is currently #15 in the queue.
We will provide further updates in the coming days.
```

- Writes message to Column N

**Step 4: Auto-Sync (10 seconds later)**
- Dashboard reads Column N
- Displays auto-response in case detail view

**Step 5: View Result**
- Open case in dashboard
- See all fields updated:
  - Cluster: "Downtown Cluster" ✅
  - Office: "GSO" ✅
  - MyNaga App Status: "In Progress" ✅
  - Updates Sent to User: (auto-response message) ✅

---

## 🔄 Two-Way Sync Behavior

### Dashboard → Google Sheets

| Action | Dashboard | → | Google Sheets | Trigger |
|--------|-----------|---|---------------|---------|
| Edit Cluster | Save case | → | Update Column D | Immediate |
| Assign Office | Save case | → | Update Column I | Immediate + AppScript trigger |
| Change Status | Save case | → | Update Column M | Immediate |

### Google Sheets → Dashboard

| Action | Google Sheets | → | Dashboard | Delay |
|--------|---------------|---|-----------|-------|
| Manual edit Column D | Edit cluster | → | Updates cluster field | 10 seconds |
| AppScript writes Column N | Auto-response | → | Shows in case detail | 10 seconds |
| Manual edit Column M | Edit status | → | Updates status | 10 seconds |

---

## 🎨 UI Changes

### Edit Mode Form

**New Fields Added:**
```
┌─────────────────────────────────────────────┐
│ Control No: [CN-2024-1234]  Category: [...] │
│ Barangay: [...]              Cluster: [...]  │
│                                              │
│ Office: [Select Office ▼]                   │
│ ┌─ PSO - Public Safety Office               │
│ ├─ GSO - General Services Office            │
│ └─ CEO - CMO Special Unit for Engineering   │
│                                              │
│ MyNaga App Status: [Select Status ▼]        │
│ ┌─ In Progress                               │
│ ├─ Pending Confirmation                      │
│ ├─ Under Review                              │
│ ├─ Resolved                                  │
│ └─ Rejected - Out of Scope                   │
│                                              │
│ Status: [OPEN ▼]                            │
│                                              │
│ [Updates Sent to User - Read Only]          │
│ ┌───────────────────────────────────────┐  │
│ │ Auto-response message appears here... │  │
│ └───────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

### View Mode Display

**New Sections:**
```
┌─────────────────────────────────────────────┐
│ 📍 Cluster: Downtown Cluster                 │
│ 📄 Assigned Office: GSO                      │
│ ...other fields...                           │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 📄 Updates Sent to User                      │
│ ┌─────────────────────────────────────────┐ │
│ │ The City Mayor's Office (CMO) has...   │ │
│ │ Your report is currently #15 in queue  │ │
│ └─────────────────────────────────────────┘ │
└─────────────────────────────────────────────┘
```

---

## 🛠️ Technical Implementation

### Database Schema

**New Columns Added:**
```sql
ALTER TABLE cases ADD COLUMN cluster VARCHAR(255);
ALTER TABLE cases ADD COLUMN office VARCHAR(255);
ALTER TABLE cases ADD COLUMN updates_sent_to_user_new TEXT;
```

**Note:** `updates_sent_to_user` was previously a BOOLEAN. New TEXT field is `updates_sent_to_user_new`.

### Backend Changes

#### 1. Models (`models.py`)
```python
class Case(Base):
    ...
    cluster = Column(String(255))  # Column D
    office = Column(String(255))  # Column I
    mynaga_app_status = Column(String(50))  # Column M
    updates_sent_to_user_new = Column(Text)  # Column N
    ...
```

#### 2. Schemas (`schemas.py`)
```python
class CaseUpdate(BaseModel):
    cluster: Optional[str] = None
    office: Optional[str] = None
    mynaga_app_status: Optional[str] = None
    updates_sent_to_user_new: Optional[str] = None
    ...
```

#### 3. Google Sheets Sync (`google_sheets_sync.py`)
```python
# Column mapping for read
column_mappings = {
    'cluster': ['Cluster', 'Cluster Group', 'Group'],
    'office': ['Office', 'Office Code', 'Assigned Office'],
    'mynaga_app_status': ['MyNaga App Status', 'App Status'],
    'updates_sent_to_user_new': ['Updates Sent to User', 'Auto Response'],
}

# Write-back logic
existing_row[3] = case_data.get('cluster', '')  # Column D
existing_row[8] = case_data.get('office', '')  # Column I
existing_row[12] = case_data.get('mynaga_app_status', '')  # Column M
existing_row[13] = case_data.get('updates_sent_to_user_new', '')  # Column N
```

#### 4. API Endpoint (`main.py`)
```python
@app.put("/api/cases/{case_id}")
def update_case(...):
    # Update database
    db.commit()
    
    # Sync to Google Sheets
    case_data = {
        'cluster': db_case.cluster,
        'office': db_case.office,
        'mynaga_app_status': db_case.mynaga_app_status,
        'updates_sent_to_user': db_case.updates_sent_to_user_new,
    }
    write_case_to_sheet(case_data, sheet_url, credentials)
```

### Frontend Changes

#### CaseModal.jsx
```jsx
// New dropdown for Office
<select name="office" ...>
  <option value="PSO">PSO - Public Safety Office</option>
  <option value="GSO">GSO - General Services Office</option>
  ...
</select>

// New dropdown for MyNaga App Status
<select name="mynaga_app_status" ...>
  <option value="In Progress">In Progress</option>
  <option value="Pending Confirmation">Pending Confirmation</option>
  ...
</select>

// Read-only display of auto-response
{caseData.updates_sent_to_user_new && (
  <div className="bg-blue-50">
    <textarea readOnly value={caseData.updates_sent_to_user_new} />
  </div>
)}
```

---

## 🔍 AppScript Integration

Your existing AppScript handles the auto-response generation. Here's how it integrates:

### Trigger Point
```javascript
function onEdit(e) {
  // Triggers when Column I (Office) is edited
  if (editedColumn === COLUMN.OFFICE_CODE) {
    const officeValue = sheet.getRange(row, COLUMN.OFFICE_CODE).getValue();
    const categoryValue = sheet.getRange(row, COLUMN.CATEGORY).getValue();
    
    // Generate message based on office
    const message = generateOfficeMessage(officeValue, categoryValue, ss);
    
    // Write to Column N
    sheet.getRange(row, COLUMN.MESSAGE_OUTPUT).setValue(message);
  }
}
```

### Message Generation Logic
```javascript
// Queue-based offices
if (queueMap[office]) {
  const queueNumber = getQueueNumber(office, dailyReportingSheet);
  const longName = longNameMap[office];
  message = `The City Mayor's Office (CMO) has processed your submission.
Your report/request is now in queue to be handled by the ${longName} through MyNaga App.
...Your report is currently #${queueNumber} in the queue...`;
}

// Fixed-message offices
if (fixedMessageMap[office]) {
  message = fixedMessageMap[office];
}
```

### Integration Flow
```
Dashboard Edit Office → 
  Google Sheets Column I Updated → 
    AppScript onEdit Trigger → 
      Read Column I (Office) → 
        Read Column C (Category) → 
          Generate Message → 
            Write to Column N → 
              Auto-Sync (10s) → 
                Dashboard Reads Column N → 
                  Display in Case Detail
```

---

## 🧪 Testing

### Test Scenario 1: Assign Office with Queue

1. Edit case, assign Office: **"PSO"**
2. Save case
3. Check Google Sheets Column I: Should show "PSO"
4. Wait 5-10 seconds for AppScript
5. Check Column N: Should show queue message
6. Wait 10 seconds for auto-sync
7. View case in dashboard
8. Verify auto-response displays

**Expected Result:**
```
The City Mayor's Office (CMO) has processed your submission.
Your report/request is now in queue to be handled by the Public Safety Office (PSO) through MyNaga App.
...Your report is currently #<queue_number> in the queue...
```

### Test Scenario 2: Assign Fixed-Message Office

1. Edit case, assign Office: **"MNWD"**
2. Save case
3. Check Column I: "MNWD"
4. AppScript writes fixed message to Column N
5. Dashboard displays after 10 seconds

**Expected Result:**
```
We sincerely apologize for any inconvenience this may cause.
Please be informed that the MyNaga App no longer handles the complaint desks of offices outside the City Hall, including the Metro Naga Water District (MNWD).
For assistance and concerns, you may directly contact MNWD through the following numbers:
📞 0919-648-6365
📞 0967-485-3679
📞 054-206-30040
```

### Test Scenario 3: Edit Cluster

1. Edit case, set Cluster: **"Downtown Cluster"**
2. Save
3. Check Column D: Should show "Downtown Cluster"
4. Edit in Google Sheets Column D: Change to "Uptown Cluster"
5. Wait 10 seconds
6. Dashboard auto-refreshes and shows "Uptown Cluster"

---

## 🐛 Troubleshooting

### Issue: Office selection doesn't trigger auto-response

**Symptoms:**
- Changed office in dashboard
- Column I updated in Google Sheets
- Column N remains empty

**Solution:**
1. Check if AppScript is active:
   - Open Google Sheets
   - Extensions → Apps Script
   - Verify `onEdit` function is saved and deployed
2. Check AppScript execution logs:
   - Executions tab in Apps Script editor
   - Look for errors or failed runs
3. Manually test AppScript:
   - Edit Column I directly in Google Sheets
   - Column N should update immediately
4. Verify "Daily Reporting" sheet exists (for queue numbers)

### Issue: Auto-response not showing in dashboard

**Symptoms:**
- Column N has content in Google Sheets
- Dashboard case detail doesn't show message

**Solution:**
1. Wait for auto-sync (10 seconds)
2. Hard refresh the page: `Cmd+Shift+R` (Mac) or `Ctrl+F5` (Windows)
3. Check backend logs:
   ```bash
   tail -f backend.log | grep "updates_sent_to_user"
   ```
4. Verify database:
   ```bash
   sqlite3 test.db "SELECT control_no, updates_sent_to_user_new FROM cases WHERE control_no = 'CN-2024-1234'"
   ```

### Issue: Cluster or Office not syncing to Google Sheets

**Symptoms:**
- Changed cluster/office in dashboard
- Google Sheets columns remain empty

**Solution:**
1. Check if auto-sync is running:
   ```bash
   curl http://localhost:8000/api/google-sheets/status
   ```
2. Check Service Account permissions (must be **Editor**, not Viewer)
3. Check backend logs for sync errors:
   ```bash
   tail -f backend.log | grep -i "sync\|sheet"
   ```
4. Manually trigger sync:
   ```bash
   curl -X POST http://localhost:8000/api/google-sheets/sync \
     -H "Content-Type: application/json" \
     -d '{"sheet_url": "..."}'
   ```

---

## 📈 Benefits

### 1. **Centralized Office Management**
- All office assignments in one place
- Easy tracking of which office handles what
- No more manual spreadsheet editing

### 2. **Automated Citizen Communication**
- AppScript generates professional responses
- Queue numbers automatically included
- Consistent messaging across all cases

### 3. **Real-Time Status Updates**
- MyNaga App status visible in dashboard
- Team members see latest status instantly
- Reduces confusion and duplicate work

### 4. **Better Case Organization**
- Cluster field for geographic grouping
- Filter by office or cluster
- Improved reporting and analytics

### 5. **Audit Trail**
- All changes logged in database
- Google Sheets version history
- Track who edited what and when

---

## 🚦 System Status

### Check if Everything is Running

```bash
# 1. Check backend
curl http://localhost:8000/api/stats

# 2. Check auto-sync status
curl http://localhost:8000/api/google-sheets/status

# 3. Check frontend
lsof -i:3000

# 4. Check database
sqlite3 /path/to/test.db "SELECT COUNT(*) FROM cases WHERE cluster IS NOT NULL"
```

### Restart Everything

```bash
# 1. Stop backend
lsof -ti:8000 | xargs kill -9

# 2. Start backend
cd backend
python3 -m uvicorn main:app --reload --host 0.0.0.0 --port 8000 &

# 3. Restart auto-sync
bash restart_autosync.sh

# 4. Check frontend (should already be running)
# Navigate to http://localhost:3000
```

---

## 📚 Related Documentation

- **TWO_WAY_SYNC.md** - Main two-way sync documentation
- **GOOGLE_SHEETS_SUMMARY.md** - Google Sheets integration guide
- **CASE_DETAIL_VIEW.md** - Case detail modal documentation
- **AppScript Code** - Your existing onEdit trigger script

---

## 🎉 Summary

You now have a **powerful, automated case management system** with:

✅ **Dashboard Editing**: Cluster, Office, MyNaga App Status  
✅ **Two-Way Sync**: Dashboard ↔ Google Sheets  
✅ **AppScript Integration**: Automated citizen responses  
✅ **Real-Time Updates**: 10-second auto-sync  
✅ **Professional UI**: Clean, government-style design  

**Try it now:**
1. Go to http://localhost:3000/cases
2. Click any case
3. Click "Edit Case"
4. Change Office to "PSO"
5. Save and wait 10-20 seconds
6. View case again to see auto-response! 🚀

---

**Questions or Issues?**  
Check the troubleshooting section or review the backend logs for detailed error messages.
